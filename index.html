<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caribbean Heat Stress Atlas — Base Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    /* Minimal legend styling */
    .legend {
      background: #fff; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      font: 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      min-width: 160px;
    }
    .legend h4 { margin: 0 0 6px; font-size: 12px; }
    .legend .placeholder { color: #666; }

    .slider-wrap {
  background:#fff; padding:8px 10px; border:1px solid #ccc; border-radius:6px;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
  font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  min-width:220px;
}
.slider-wrap .label { display:block; margin-bottom:6px; font-weight:600; }
.slider-wrap input[type="range"] { width:100%; }
.slider-wrap .value { font-variant-numeric: tabular-nums; }

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
      // ---------------------------------------------------------
  // Caribbean Heat Stress Atlas — Metric Definitions (PLAN)
  //
  // For each station and year, the processed dataset will include:
  //
  // 1) hot_days_32c[year]
  //    - Annual number of "very hot days".
  //    - Definition: days where daily maximum temperature TMAX ≥ 32 °C.
  //
  // 2) mean_dewpoint_hot[year]
  //    - Average dew point (°C) on very hot days (TMAX ≥ 32 °C).
  //
  // 3) mean_rh_hot[year]
  //    - Average relative humidity (%) on very hot days (TMAX ≥ 32 °C).
  //
  // 4) steam_days[year]
  //    - "Steam stress" or compound hot–humid days.
  //    - Definition: days where TMAX ≥ 32 °C AND dew point ≥ 24 °C.
  //
  // Map usage (current plan):
  //  - Circle color: based on a chosen primary metric
  //    (initially hot_days_32c, later possibly steam_days).
  //  - Popup for selected year: will show all four metrics.
  //
  // NOTE: Current values in stations_example.geojson are placeholders.
  //       They will be replaced by real values from processed NOAA
  //       GHCN-Daily data in a later step.
  // ---------------------------------------------------------


    // Base map over Puerto Rico
    const prCenter = [18.2208, -66.5901];
    const map = L.map('map', { center: prCenter, zoom: 8 });

    // Add OSM tiles
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Scale bar
    L.control.scale({ metric:false, imperial:true }).addTo(map);

    // --- Minimal UI shell (no data yet) ---
    // Register baselayers (OSM already on map)
    const baseLayers = {
      "OpenStreetMap": osm
    };
    const overlays = {}; // will hold PR boundary and rasters later

    // Layer control (open during dev)
    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    const legend = L.control({ position: 'bottomright' });
legend.onAdd = function () {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = `
    <h4>Very hot days per year<br/><small>(Tmax ≥ 32 °C)</small></h4>
    <div><span style="
      display:inline-block;width:14px;height:14px;
      background:#4575b4;border:1px solid #ccc;margin-right:6px;"></span>
      &lt; 30 days
    </div>
    <div><span style="
      display:inline-block;width:14px;height:14px;
      background:#91bfdb;border:1px solid #ccc;margin-right:6px;"></span>
      30 – 59 days
    </div>
    <div><span style="
      display:inline-block;width:14px;height:14px;
      background:#fee090;border:1px solid #ccc;margin-right:6px;"></span>
      60 – 89 days
    </div>
    <div><span style="
      display:inline-block;width:14px;height:14px;
      background:#fdae61;border:1px solid #ccc;margin-right:6px;"></span>
      90 – 119 days
    </div>
    <div><span style="
      display:inline-block;width:14px;height:14px;
      background:#d73027;border:1px solid #ccc;margin-right:6px;"></span>
      ≥ 120 days
    </div>
    <div style="margin-top:4px;"><span style="
      display:inline-block;width:14px;height:14px;
      background:#999999;border:1px solid #ccc;margin-right:6px;"></span>
      No data
    </div>
  `;
  return div;
};
legend.addTo(map);



    // --- Puerto Rico boundary overlay (temporary bbox) ---
    //NEED TO UPDATE NOT FINISHED !!!!!!!!!!!!!!!!
    
fetch('data/pr_boundary.geojson')
  .then(r => r.json())
  .then(geo => {
    const prBoundary = L.geoJSON(geo, {
      style: { color: '#333', weight: 2, fill: false },
      onEachFeature: (f, layer) => {
        const label = f?.properties?.name || 'Puerto Rico';
        layer.bindTooltip(label, { sticky: true });
      }
    }).addTo(map);

    // Add to layer control & zoom to it
    layerControl.addOverlay(prBoundary, 'Puerto Rico boundary');
    map.fitBounds(prBoundary.getBounds(), { padding: [12, 12] });
  })
  .catch(err => console.error('Failed to load PR boundary:', err));

// --- Station data (placeholder wiring) ---
let stationsData = null;
let stationLayer = null;           // current markers layer
let stationsOverlayAdded = false;  // so we only add overlay once

function getColorForValue(v) {
  if (v == null) return '#999999';   // no data
  if (v < 30)   return '#4575b4';    // < 30 days
  if (v < 60)   return '#91bfdb';    // 30–59
  if (v < 90)   return '#fee090';    // 60–89
  if (v < 120)  return '#fdae61';    // 90–119
  return '#d73027';                  // ≥ 120
}

function drawStationsForYear(year) {
  if (!stationsData) {
    console.warn('No stationsData loaded yet');
    return;
  }

  // Remove previous layer if it exists
  if (stationLayer) {
    map.removeLayer(stationLayer);
  }

  stationLayer = L.geoJSON(stationsData, {
    // Only draw features that have a real value for this year
    filter: (feature) => {
      const v = feature.properties.values[year];
      return v != null && !Number.isNaN(v);
    },
    pointToLayer: (feature, latlng) => {
      const val = feature.properties.values[year];
      return L.circleMarker(latlng, {
        radius: 6,
        color: '#333',
        weight: 1,
        fillColor: getColorForValue(val),
        fillOpacity: 0.9
      });
    },
    onEachFeature: (feature, layer) => {
      const val = feature.properties.values[year];
      const display = `${val} days`;
      layer.bindPopup(`
        <strong>${feature.properties.name}</strong><br/>
        ${feature.properties.country}<br/>
        Year: ${year}<br/>
        Very hot days (Tmax ≥ 32 °C): <strong>${display}</strong>
      `);
    }
  }).addTo(map);

  // Add to layer control only once
  if (!stationsOverlayAdded) {
    layerControl.addOverlay(stationLayer, 'Very hot days (Tmax ≥ 32 °C)');
    stationsOverlayAdded = true;
  }
}




fetch('data/stations_all_hotdays.geojson')
  .then(r => r.json())
  .then(geo => {
    stationsData = geo;
    console.log('Loaded stations data:', stationsData);

    const firstFeature = stationsData.features[0];
    YEARS = Object.keys(firstFeature.properties.values).sort();
    initTimeSlider(YEARS);
    drawStationsForYear(YEARS[0]);
  })
  .catch(err => console.error('Failed to load stations data:', err));




    // --- Time slider placeholder (disabled until data exists) ---
const SliderControl = L.Control.extend({
  options: { position: 'topright' },
  onAdd: function () {
    const wrap = L.DomUtil.create('div', 'slider-wrap');
    wrap.innerHTML = `
      <span class="label">Time</span>
      <input id="timeRange" type="range" min="0" max="11" value="0" disabled />
      <span class="value" id="timeLabel">Not available</span>
    `;
    // prevent map drag/zoom while interacting with control
    L.DomEvent.disableClickPropagation(wrap);
    L.DomEvent.disableScrollPropagation(wrap);
    return wrap;
  }
});
map.addControl(new SliderControl());

// --- Time slider wiring (dummy years for now) ---


let YEARS = [];   // will be filled once data loads



function initTimeSlider(years) {
  const range = document.getElementById('timeRange');
  const label = document.getElementById('timeLabel');

  if (!range || !label) {
    console.warn('Time slider elements not found in DOM');
    return;
  }

  // Configure the slider based on how many years we have
  range.disabled = false;                    // enable it
  range.min = 0;
  range.max = years.length - 1;
  range.value = 0;

  // Set initial label
  label.textContent = years[0];

  range.addEventListener('input', () => {
  const idx = Number(range.value);
  const year = years[idx];
  label.textContent = year;

  console.log('Selected year:', year);
  drawStationsForYear(year);
});
}

  </script>
</body>
</html>

