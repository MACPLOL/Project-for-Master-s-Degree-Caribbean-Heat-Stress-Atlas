<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caribbean Heat Stress Atlas — Base Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    /* Minimal legend styling */
    .legend {
      background: #fff; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      font: 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      min-width: 160px;
    }
    .legend h4 { margin: 0 0 6px; font-size: 12px; }
    .legend .placeholder { color: #666; }

    .slider-wrap {
  background:#fff; padding:8px 10px; border:1px solid #ccc; border-radius:6px;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
  font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  min-width:220px;
}
.slider-wrap .label { display:block; margin-bottom:6px; font-weight:600; }
.slider-wrap input[type="range"] { width:100%; }
.slider-wrap .value { font-variant-numeric: tabular-nums; }

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Base map over Puerto Rico
    const prCenter = [18.2208, -66.5901];
    const map = L.map('map', { center: prCenter, zoom: 8 });

    // Add OSM tiles
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Scale bar
    L.control.scale({ metric:false, imperial:true }).addTo(map);

    // --- Minimal UI shell (no data yet) ---
    // Register baselayers (OSM already on map)
    const baseLayers = {
      "OpenStreetMap": osm
    };
    const overlays = {}; // will hold PR boundary and rasters later

    // Layer control (open during dev)
    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // Legend placeholder
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `<h4>Legend</h4><div class="placeholder">No layer selected.</div>`;
      return div;
    };
    legend.addTo(map);

    // --- Puerto Rico boundary overlay (temporary bbox) ---
    //NEED TO UPDATE NOT FINISHED !!!!!!!!!!!!!!!!
    
fetch('data/pr_boundary.geojson')
  .then(r => r.json())
  .then(geo => {
    const prBoundary = L.geoJSON(geo, {
      style: { color: '#333', weight: 2, fill: false },
      onEachFeature: (f, layer) => {
        const label = f?.properties?.name || 'Puerto Rico';
        layer.bindTooltip(label, { sticky: true });
      }
    }).addTo(map);

    // Add to layer control & zoom to it
    layerControl.addOverlay(prBoundary, 'Puerto Rico boundary');
    map.fitBounds(prBoundary.getBounds(), { padding: [12, 12] });
  })
  .catch(err => console.error('Failed to load PR boundary:', err));

// --- Station data (placeholder wiring) ---
let stationsData = null;
let stationLayer = null;           // current markers layer
let stationsOverlayAdded = false;  // so we only add overlay once

function getColorForValue(v) {
  if (v == null) return '#999999';   // no data
  if (v < 31)   return '#4575b4';
  if (v < 32)   return '#91bfdb';
  if (v < 33)   return '#fee090';
  if (v < 34)   return '#fdae61';
  return '#d73027';
}

function drawStationsForYear(year) {
  if (!stationsData) {
    console.warn('No stationsData loaded yet');
    return;
  }

  // Remove previous layer if it exists
  if (stationLayer) {
    map.removeLayer(stationLayer);
  }

  stationLayer = L.geoJSON(stationsData, {
    pointToLayer: (feature, latlng) => {
      const val = feature.properties.values[year];
      return L.circleMarker(latlng, {
        radius: 6,
        color: '#333',
        weight: 1,
        fillColor: getColorForValue(val),
        fillOpacity: 0.9
      });
    },
    onEachFeature: (feature, layer) => {
      const val = feature.properties.values[year];
      layer.bindPopup(`
        <strong>${feature.properties.name}</strong><br/>
        ${feature.properties.country}<br/>
        ${year} value: ${val != null ? val.toFixed(1) + ' °C' : 'N/A'}
      `);
    }
  }).addTo(map);

  // Add to layer control only once
  if (!stationsOverlayAdded) {
    layerControl.addOverlay(stationLayer, 'Heat metric (example)');
    stationsOverlayAdded = true;
  }
}


fetch('data/stations_example.geojson')
  .then(r => r.json())
  .then(geo => {
    stationsData = geo;
    console.log('Loaded stations data:', stationsData);
    drawStationsForYear(YEARS[0]);   // draw initial markers for first year
  })
  .catch(err => console.error('Failed to load stations data:', err));



    // --- Time slider placeholder (disabled until data exists) ---
const SliderControl = L.Control.extend({
  options: { position: 'topright' },
  onAdd: function () {
    const wrap = L.DomUtil.create('div', 'slider-wrap');
    wrap.innerHTML = `
      <span class="label">Time</span>
      <input id="timeRange" type="range" min="0" max="11" value="0" disabled />
      <span class="value" id="timeLabel">Not available</span>
    `;
    // prevent map drag/zoom while interacting with control
    L.DomEvent.disableClickPropagation(wrap);
    L.DomEvent.disableScrollPropagation(wrap);
    return wrap;
  }
});
map.addControl(new SliderControl());

// --- Time slider wiring (dummy years for now) ---

// Later these will match the actual years in your dataset pacienciaaaa
const YEARS = ['2000', '2005', '2010', '2015', '2020'];

function initTimeSlider(years) {
  const range = document.getElementById('timeRange');
  const label = document.getElementById('timeLabel');

  if (!range || !label) {
    console.warn('Time slider elements not found in DOM');
    return;
  }

  // Configure the slider based on how many years we have
  range.disabled = false;                    // enable it
  range.min = 0;
  range.max = years.length - 1;
  range.value = 0;

  // Set initial label
  label.textContent = years[0];

  range.addEventListener('input', () => {
  const idx = Number(range.value);
  const year = years[idx];
  label.textContent = year;

  console.log('Selected year:', year);
  drawStationsForYear(year);
});
}

// Initialize the slider once the control has been added to the map
initTimeSlider(YEARS);
  </script>
</body>
</html>

